<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>b&b mobile - finance tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* custom scrollbar for transaction lists */
        .transaction-list::-webkit-scrollbar {
            width: 6px;
        }
        .transaction-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .transaction-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .transaction-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- main container -->
    <div class="container mx-auto p-4 sm:p-6 max-w-4xl">

        <!-- header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">b&b mobile</h1>
            <p class="text-lg text-gray-600">public finance tracker</p>
        </header>

        <!-- main content -->
        <main id="main-content">
            <!-- loading spinner -->
            <div id="loading" class="flex justify-center items-center mt-8">
                <div class="loader"></div>
                <p class="ml-4 text-gray-500">loading data...</p>
            </div>

            <!-- app body, hidden until data loads -->
            <div id="app-body" class="hidden">
                <!-- summary cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <h2 class="text-lg font-semibold text-green-800">total income</h2>
                        <p id="total-income" class="text-2xl font-bold text-green-900">npr 0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg shadow">
                        <h2 class="text-lg font-semibold text-red-800">total expenses</h2>
                        <p id="total-expenses" class="text-2xl font-bold text-red-900">npr 0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <h2 class="text-lg font-semibold text-blue-800">profit</h2>
                        <p id="total-profit" class="text-2xl font-bold text-blue-900">npr 0</p>
                    </div>
                </div>

                <!-- income and expense columns -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <!-- income column -->
                    <div class="bg-white p-5 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-green-600">paisa aayo (income)</h2>
                        <form id="income-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" id="income-desc" placeholder="e.g., phone repair" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none" required>
                            <input type="number" id="income-amount" placeholder="amount" class="w-full sm:w-28 p-2 border rounded-md focus:ring-2 focus:ring-green-400 focus:outline-none" required>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 font-semibold transition-colors">add</button>
                        </form>
                        <div id="income-list" class="transaction-list max-h-80 overflow-y-auto space-y-2">
                            <!-- income items will be added here -->
                        </div>
                    </div>

                    <!-- expense column -->
                    <div class="bg-white p-5 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4 text-red-600">paisa gayo (expenses)</h2>
                        <form id="expense-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" id="expense-desc" placeholder="e.g., parts, rent" class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-red-400 focus:outline-none" required>
                            <input type="number" id="expense-amount" placeholder="amount" class="w-full sm:w-28 p-2 border rounded-md focus:ring-2 focus:ring-red-400 focus:outline-none" required>
                            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 font-semibold transition-colors">add</button>
                        </form>
                        <div id="expense-list" class="transaction-list max-h-80 overflow-y-auto space-y-2">
                            <!-- expense items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- delete confirmation modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4">confirm deletion</h3>
            <p class="text-gray-600 mb-6">are you sure you want to delete this entry? this action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">cancel</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">delete</button>
            </div>
        </div>
    </div>

    <!-- firebase sdk -->
    <script type="module">
        // --- firebase configuration ---
        // this is the configuration you provided.
        const firebaseConfig = {
            apiKey: "AIzaSyAfMU35NJj9Iq59H6OtXC0YDh2gPxXbZPk",
            authDomain: "bb-mobilee.firebaseapp.com",
            projectId: "bb-mobilee",
            storageBucket: "bb-mobilee.appspot.com",
            messagingSenderId: "1093289169212",
            appId: "1:1093289169212:web:648f17a21e72ea76bb8e39",
            measurementId: "G-FE6TXSBX42"
        };
        
        // --- firebase imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- firebase initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- global variables ---
        let transactionToDeleteId = null;
        
        // --- dom elements ---
        const loadingEl = document.getElementById('loading');
        const appBodyEl = document.getElementById('app-body');
        const incomeForm = document.getElementById('income-form');
        const expenseForm = document.getElementById('expense-form');
        const incomeList = document.getElementById('income-list');
        const expenseList = document.getElementById('expense-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalProfitEl = document.getElementById('total-profit');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');

        // --- firestore data listener ---
        // this path is now public, so anyone can read/write.
        const publicTransactionsPath = 'public_transactions';
        const q = query(collection(db, publicTransactionsPath));

        onSnapshot(q, (querySnapshot) => {
            const transactions = [];
            querySnapshot.forEach((doc) => {
                transactions.push({ id: doc.id, ...doc.data() });
            });
            // sort by timestamp in descending order (newest first)
            transactions.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            renderTransactions(transactions);
            
            // hide loader and show app body once data is loaded
            loadingEl.style.display = 'none';
            appBodyEl.classList.remove('hidden');

        }, (error) => {
            console.error("error fetching transactions:", error);
            loadingEl.textContent = "could not fetch data. check console for errors.";
        });

        // --- render ui ---
        function renderTransactions(transactions) {
            incomeList.innerHTML = '';
            expenseList.innerHTML = '';
            let totalIncome = 0;
            let totalExpenses = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeList.innerHTML += createTransactionItem(t, 'green');
                } else if (t.type === 'expense') {
                    totalExpenses += t.amount;
                    expenseList.innerHTML += createTransactionItem(t, 'red');
                }
            });
            
            const profit = totalIncome - totalExpenses;
            totalIncomeEl.textContent = `npr ${totalIncome.toLocaleString()}`;
            totalExpensesEl.textContent = `npr ${totalExpenses.toLocaleString()}`;
            totalProfitEl.textContent = `npr ${profit.toLocaleString()}`;

            totalProfitEl.classList.remove('text-green-900', 'text-red-900', 'text-blue-900');
            if (profit > 0) totalProfitEl.classList.add('text-green-900');
            else if (profit < 0) totalProfitEl.classList.add('text-red-900');
            else totalProfitEl.classList.add('text-blue-900');
        }

        // --- create html for a single transaction item ---
        function createTransactionItem(transaction, color) {
            const date = transaction.timestamp ? transaction.timestamp.toDate().toLocaleDateString('en-np') : 'just now';
            return `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md border-l-4 border-${color}-400">
                    <div>
                        <p class="font-medium capitalize">${transaction.description}</p>
                        <p class="text-xs text-gray-500">${date}</p>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                       <p class="font-bold text-md sm:text-lg">npr ${transaction.amount.toLocaleString()}</p>
                       <button data-id="${transaction.id}" class="delete-btn text-gray-400 hover:text-red-600 text-2xl font-bold transition-colors">&times;</button>
                    </div>
                </div>
            `;
        }

        // --- add transaction function ---
        async function addTransaction(type, description, amount) {
            try {
                await addDoc(collection(db, publicTransactionsPath), {
                    type: type,
                    description: description,
                    amount: Number(amount),
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("error adding document: ", error);
                alert("could not save transaction. please try again.");
            }
        }

        // --- delete transaction function ---
        async function deleteTransaction(id) {
            try {
                await deleteDoc(doc(db, publicTransactionsPath, id));
            } catch (error) {
                console.error("error deleting document: ", error);
                alert("could not delete transaction.");
            }
        }

        // --- event listeners ---
        incomeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const desc = document.getElementById('income-desc').value;
            const amount = document.getElementById('income-amount').value;
            if (desc && amount > 0) {
                addTransaction('income', desc, amount);
                incomeForm.reset();
            }
        });

        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const desc = document.getElementById('expense-desc').value;
            const amount = document.getElementById('expense-amount').value;
            if (desc && amount > 0) {
                addTransaction('expense', desc, amount);
                expenseForm.reset();
            }
        });

        // --- modal event listeners ---
        // event delegation for delete buttons
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                transactionToDeleteId = e.target.getAttribute('data-id');
                deleteModal.classList.remove('hidden');
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            transactionToDeleteId = null;
            deleteModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (transactionToDeleteId) {
                deleteTransaction(transactionToDeleteId);
            }
            transactionToDeleteId = null;
            deleteModal.classList.add('hidden');
        });

    </script>
</body>
</html>
